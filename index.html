<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard JIM Terengganu</title>
    <!-- START PWA / MOBILE HOME SCREEN SETUP -->
    
    <!-- Apple PWA Meta Tags (untuk iOS) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Ikon 180x180px anda digunakan di sini (Untuk iOS) -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://ibb.co/KzNs18PN">
    
    <!-- Android / Chrome / Standard Icon -->
    <!-- Ikon yang sama digunakan untuk 192x192px -->
    <link rel="icon" type="image/png" sizes="192x192" href="https://ibb.co/KzNs18PN">
    <!-- GANTIKAN URL DI BAWAH DENGAN IKON 32x32px YANG KHAS JIKA ADA -->
    <link rel="icon" type="image/png" sizes="32x32" href="GANTIKAN_DENGAN_URL_IKON_32x32_ANDA">

    <!-- Standard PWA Manifest Link (Walaupun aplikasi satu fail, link ini membantu browser Chrome mencetuskan prompt A2HS) -->
    <link rel="manifest" href="/manifest.webmanifest"> 

    <!-- END PWA / MOBILE HOME SCREEN SETUP -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            /* KEMASKINI LATAR BELAKANG */
            /* PAUTAN DIRECT LINK BARU DARI IMGBB */
            background-image: url('https://i.ibb.co/TqLLCsyN/Untitled-design-1.jpg'); 
            background-size: cover; /* Pastikan imej mengisi seluruh skrin */
            background-attachment: fixed; /* Latar belakang tidak bergerak semasa skrol */
            background-position: center; /* Pusat imej */
            /* Warna fallback jika imej gagal dimuatkan */
            background-color: #000; 
        }
        
        /* Tambah lapisan overlay gelap untuk memastikan teks putih mudah dibaca */
        .background-overlay {
            background-color: rgba(0, 0, 0, 0.6); /* Tambah 60% overlay hitam */
            min-height: 100vh;
        }

        /* [CSS lain tidak diubah...] */

        .fade-in {
            animation: fadeIn 0.8s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .glow-effect {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        .glow-effect:hover {
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
        }
        .gradient-text {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .spinner {
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .slide-up {
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.6); }
        }
        /* Custom Modal Styles */
        .modal {
            background-color: rgba(0, 0, 0, 0.7);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            animation: slideUp 0.3s ease-out;
        }
        
        /* FIX: Custom class untuk menolak notifikasi keluar skrin secara agresif */
        .off-screen-right {
            transform: translateX(120%); /* Jamin ia ditolak 120% keluar */
        }
        
    </style>
</head>
<body class="min-h-screen">
    <!-- Overlay untuk latar belakang gelap dan teks lebih mudah dibaca -->
    <div class="background-overlay"> 
        <!-- Login Page -->
        <div id="loginPage" class="min-h-screen flex items-center justify-center">
            <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl p-10 max-w-md w-full mx-4 border border-gray-700 glow-effect">
                <div class="text-center mb-8">
                    <img src="https://i.ibb.co/7hw6nmH/logo.png" alt="Logo JIM Terengganu" class="h-24 w-auto mb-4 pulse-glow rounded-lg mx-auto" onerror="this.src='https://placehold.co/96x96/1f2937/d1d5db?text=JIM'; this.alt='Logo JIM Terengganu'; this.style.display='block';">
                    <h1 class="text-3xl font-bold gradient-text mb-2">JIM Terengganu</h1>
                    <p class="text-gray-300">Sistem Pangkalan Data & Statistik</p>
                </div>
                
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label class="block text-lg font-medium text-gray-300 mb-3">Nama Pengguna</label>
                        <input type="text" id="username" class="w-full px-5 py-4 bg-gray-700 border border-gray-600 rounded-xl text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300" placeholder="Masukkan nama pengguna" required>
                    </div>
                    
                    <div>
                        <label class="block text-lg font-medium text-gray-300 mb-3">Kata Laluan</label>
                        <input type="password" id="password" class="w-full px-5 py-4 bg-gray-700 border border-gray-600 rounded-xl text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300" placeholder="Masukkan kata laluan" required>
                    </div>
                    
                    <button type="submit" id="loginButton" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-4 px-8 rounded-xl transition duration-300 transform hover:scale-105 glow-effect flex items-center justify-center">
                        <span id="loginButtonText">Log Masuk</span>
                        <div id="loginSpinner" class="spinner ml-3 hidden"></div>
                    </button>
                </form>
                
                <div id="loginError" class="mt-4 p-4 bg-red-600 bg-opacity-20 border border-red-500 rounded-xl text-red-400 text-center hidden">
                    <p>Nama pengguna atau kata laluan tidak sah!</p>
                </div>
            </div>
        </div>

        <!-- Header -->
        <div id="mainHeader" class="bg-gradient-to-r from-gray-800 to-gray-900 shadow-2xl border-b-4 border-blue-500 glow-effect hidden">
            <div class="container mx-auto px-6 py-8">
                <div class="flex justify-between items-center">
                    <div class="flex flex-col items-center text-center flex-1">
                        <img src="https://i.ibb.co/7hw6nmH/logo.png" alt="Logo JIM Terengganu" class="h-36 w-auto mb-6 pulse-glow rounded-lg" onerror="this.src='https://placehold.co/144x144/1f2937/d1d5db?text=JIM'; this.alt='Logo JIM Terengganu'; this.style.display='block';" >
                        <h1 class="text-4xl font-bold gradient-text mb-3">Dashboard JIM Terengganu</h1>
                        <div class="text-xl text-gray-300 max-w-2xl text-center">
                            <p>Sistem Pangkalan Data & Statistik</p>
                            <p>Jabatan Imigresen Malaysia Negeri Terengganu</p>
                        </div>
                    </div>
                    <div class="absolute top-4 right-4">
                        <div class="flex items-center gap-4">
                            <span id="currentUser" class="text-gray-300 text-sm"></span>
                            <button onclick="logout()" class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 glow-effect">
                                ðŸšª Log Keluar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="container mx-auto px-6 py-8 hidden">
            <!-- Home Page -->
            <div id="homePage" class="fade-in">
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl p-10 max-w-2xl mx-auto border border-gray-700 glow-effect">
                    <h2 class="text-3xl font-bold gradient-text mb-8 text-center">Pengumpulan Data Harian</h2>
                    
                    <form id="entryForm" class="space-y-8">
                        <div>
                            <label class="block text-lg font-medium text-gray-300 mb-3">Tarikh</label>
                            <input type="date" id="dateInput" class="w-full px-5 py-4 bg-gray-700 border border-gray-600 rounded-xl text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300" required>
                        </div>
                        
                        <div>
                            <label class="block text-lg font-medium text-gray-300 mb-3">Bahagian/Cawangan</label>
                            <select id="branchSelect" class="w-full px-5 py-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300" required>
                                <option value="">Pilih Cawangan</option>
                                <option value="DIA">Depot Imigresen Ajil (DIA)</option>
                                <option value="G">Bahagian Visa, Pas & Permit (G)</option>
                                <option value="H">Bahagian Keselamatan & Pasport (H) â€“ UTC Terengganu</option>
                                <option value="J">Bahagian Pekerja Asing (J)</option>
                                <option value="BESUT">Pejabat Imigresen Besut</option>
                                <option value="CHUKAI">Pejabat Imigresen Chukai</option>
                                <option value="DUNGUN">Pejabat Imigresen Dungun</option>
                                <option value="KERTEH">Pejabat Imigresen Kerteh</option>
                            </select>
                        </div>
                        
                        <div class="space-y-4">
                            <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-4 px-8 rounded-xl transition duration-300 transform hover:scale-105 glow-effect">
                                Mula Isi Data
                            </button>
                            
                            <button type="button" onclick="viewDashboard()" class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-4 px-8 rounded-xl transition duration-300 transform hover:scale-105 glow-effect">
                                Lihat Dashboard
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Data Entry Forms -->
            <div id="dataEntryPage" class="hidden fade-in">
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl p-10 border border-gray-700 glow-effect">
                    <div class="mb-8">
                        <h2 id="branchTitle" class="text-3xl font-bold gradient-text mb-2"></h2>
                        <p id="selectedDate" class="text-xl text-gray-300"></p>
                    </div>
                    
                    <form id="dataForm" class="space-y-8">
                        <div id="formFields"></div>
                        
                        <div class="flex flex-col gap-4">
                            <button type="submit" id="saveButton" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-4 px-8 rounded-xl transition duration-300 transform hover:scale-105 glow-effect flex items-center justify-center">
                                <span id="saveButtonText">Simpan Data</span>
                                <div id="saveSpinner" class="spinner ml-3 hidden"></div>
                            </button>
                            <button type="button" onclick="viewDashboard()" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-4 px-8 rounded-xl transition duration-300 transform hover:scale-105 glow-effect">
                                Lihat Dashboard
                            </button>
                            <button type="button" onclick="goHome()" class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-bold py-4 px-8 rounded-xl transition duration-300 transform hover:scale-105 glow-effect">
                                Kembali
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboardPage" class="hidden fade-in">
                <div class="mb-8 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                    <div>
                        <h2 class="text-3xl font-bold gradient-text mb-2">Laporan Harian</h2>
                        <div class="flex items-center gap-4">
                            <label class="text-lg font-medium text-gray-300">Pilih Tarikh:</label>
                            <input type="date" id="dashboardDateFilter" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300">
                            <button onclick="filterByDate()" class="bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 glow-effect">
                                Jana
                            </button>
                            <button onclick="goHome()" class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 glow-effect">
                                Kembali
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Summary Cards -->
                <div id="dashboardStats" class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <!-- Section 1: PMA & Kutipan -->
                    <div class="space-y-6">
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl p-8 card-hover border border-gray-700 glow-effect">
                            <div class="flex items-center">
                                <div class="p-4 bg-blue-600 rounded-full glow-effect">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                                <div class="ml-6">
                                    <p class="text-lg font-medium text-gray-300">Jumlah PMA</p>
                                    <p id="totalPMA" class="text-3xl font-bold gradient-text">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl p-8 card-hover border border-gray-700 glow-effect">
                            <div class="flex items-center">
                                <div class="p-4 bg-green-600 rounded-full glow-effect">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                    </svg>
                                </div>
                                <div class="ml-6">
                                    <p class="text-lg font-medium text-gray-300">Kutipan Hasil</p>
                                    <p id="totalRevenue" class="text-3xl font-bold gradient-text">RM 0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 2: Depot Imigresen Ajil -->
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl p-8 card-hover border border-gray-700 glow-effect">
                        <h3 class="text-2xl font-bold gradient-text mb-6 text-center">Depot Imigresen Ajil</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="p-3 bg-purple-600 rounded-full glow-effect mr-4">
                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                        </svg>
                                    </div>
                                    <p class="text-lg font-medium text-gray-300">Muster Penuh</p>
                                </div>
                                <p id="totalMuster" class="text-2xl font-bold gradient-text">0</p>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="p-3 bg-red-600 rounded-full glow-effect mr-4">
                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                        </svg>
                                    </div>
                                    <p class="text-lg font-medium text-gray-300">Baki Kekosongan</p>
                                </div>
                                <p id="totalVacancy" class="text-2xl font-bold gradient-text">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Baki Stok Dokumen Section -->
                <div class="mb-8">
                    <h3 class="text-2xl font-bold gradient-text mb-6">Baki Stok Dokumen di Bahagian & Cawangan</h3>
                    <div id="loadingMessage" class="text-center text-gray-400 py-10">
                        <div class="spinner mx-auto mb-4"></div>
                        Permintaan data Dashboard dari Server
                    </div>
                    <div id="stockCardsContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 hidden">
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-xl p-4 border border-gray-700 glow-effect">
                            <div class="text-center">
                                <div class="p-2 bg-blue-600 rounded-full glow-effect mx-auto w-fit mb-2">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                                <p class="text-xs font-medium text-gray-300 mb-1">PMA POLY</p>
                                <p id="totalPolyStock" class="text-lg font-bold gradient-text">0</p>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-xl p-4 border border-gray-700 glow-effect">
                            <div class="text-center">
                                <div class="p-2 bg-green-600 rounded-full glow-effect mx-auto w-fit mb-2">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                                <p class="text-xs font-medium text-gray-300 mb-1">DPT</p>
                                <p id="totalDptStock" class="text-lg font-bold gradient-text">0</p>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-xl p-4 border border-gray-700 glow-effect">
                            <div class="text-center">
                                <div class="p-2 bg-purple-600 rounded-full glow-effect mx-auto w-fit mb-2">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                                <p class="text-xs font-medium text-gray-300 mb-1">SAP</p>
                                <p id="totalSapStock" class="text-lg font-bold gradient-text">0</p>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-xl p-4 border border-gray-700 glow-effect">
                            <div class="text-center">
                                <div class="p-2 bg-red-600 rounded-full glow-effect mx-auto w-fit mb-2">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                                <p class="text-xs font-medium text-gray-300 mb-1">SPC</p>
                                <p id="totalSpcStock" class="text-lg font-bold gradient-text">0</p>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-xl p-4 border border-gray-700 glow-effect">
                            <div class="text-center">
                                <div class="p-2 bg-yellow-600 rounded-full glow-effect mx-auto w-fit mb-2">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                                <p class="text-xs font-medium text-gray-300 mb-1">MALPASS</p>
                                <p id="totalMalpassStock" class="text-lg font-bold gradient-text">0</p>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-xl p-4 border border-gray-700 glow-effect">
                            <div class="text-center">
                                <div class="p-2 bg-indigo-600 rounded-full glow-effect mx-auto w-fit mb-2">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                                <p class="text-xs font-medium text-gray-300 mb-1">MALVISA</p>
                                <p id="totalMalvisaStock" class="text-lg font-bold gradient-text">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl overflow-hidden border border-gray-700 glow-effect">
                    <div class="px-6 py-4 bg-gradient-to-r from-gray-700 to-gray-800 border-b border-gray-600">
                        <h3 class="text-xl font-bold gradient-text">Data Cawangan</h3>
                    </div>
                    <!-- PENAMBAHBAIKAN: Gunakan overflow-x-auto untuk Jadual pada Mobile -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs">
                            <thead class="bg-gradient-to-r from-gray-700 to-gray-800">
                                <tr>
                                    <th class="px-1 py-2 text-center text-xs font-bold text-gray-200 uppercase tracking-tight">CAWANGAN</th>
                                    <th class="px-1 py-2 text-center text-xs font-bold text-gray-200 uppercase tracking-tight">URUSNIAGA HARIAN</th>
                                    <th class="px-1 py-2 text-center text-xs font-bold text-gray-200 uppercase tracking-tight">PENGELUARAN PMA</th>
                                    <th class="px-1 py-2 text-center text-xs font-bold text-gray-200 uppercase tracking-tight">BAKI PMA</th>
                                    <th class="px-1 py-2 text-center text-xs font-bold text-gray-200 uppercase tracking-tight">BAKI DPT</th>
                                    <th class="px-1 py-2 text-center text-xs font-bold text-gray-200 uppercase tracking-tight">BAKI SAP</th>
                                    <th class="px-1 py-2 text-center text-xs font-bold text-gray-200 uppercase tracking-tight">BAKI SPC</th>
                                    <th class="px-1 py-2 text-center text-xs font-bold text-gray-200 uppercase tracking-tight">BAKI MALPASS</th>
                                    <th class="px-1 py-2 text-center text-xs font-bold text-gray-200 uppercase tracking-tight">BAKI MALVISA</th>
                                    <th class="px-1 py-2 text-center text-xs font-bold text-gray-200 uppercase tracking-tight">KUTIPAN HASIL (RM)</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody" class="bg-gradient-to-br from-gray-800 to-gray-900 divide-y divide-gray-700">
                                <!-- Rows are dynamically generated -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Button to Data Terperinci -->
                <div class="mt-8 text-center">
                    <button onclick="viewDataTerperinci()" class="bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-4 px-8 rounded-xl transition duration-300 transform hover:scale-105 glow-effect">
                        ðŸ“Š Lihat Data Terperinci
                    </button>
                </div>
            </div>

            <!-- Data Terperinci Page -->
            <div id="dataTerinciPage" class="hidden fade-in">
                <div class="mb-8 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                    <div>
                        <h2 class="text-3xl font-bold gradient-text mb-2">Data Terperinci</h2>
                        <p class="text-lg text-gray-300">Maklumat lengkap semua data yang dimasukkan</p>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="viewDashboard()" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 glow-effect">
                            Kembali ke Dashboard
                        </button>
                        <button onclick="goHome()" class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 glow-effect">
                            Halaman Utama
                        </button>
                    </div>
                </div>
                
                <!-- Filter Section -->
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl p-6 mb-8 border border-gray-700 glow-effect">
                    <h3 class="text-xl font-bold gradient-text mb-4">Penapis Data</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Cawangan</label>
                            <select id="filterBranch" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300">
                                <option value="">Semua Cawangan</option>
                                <option value="DIA">Depot Imigresen Ajil (DIA)</option>
                                <option value="G">Bahagian Visa, Pas & Permit (G)</option>
                                <option value="H">Bahagian Keselamatan & Pasport (H)</option>
                                <option value="J">Bahagian Pekerja Asing (J)</option>
                                <option value="BESUT">Pejabat Imigresen Besut</option>
                                <option value="CHUKAI">Pejabat Imigresen Chukai</option>
                                <option value="DUNGUN">Pejabat Imigresen Dungun</option>
                                <option value="KERTEH">Pejabat Imigresen Kerteh</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Pilihan Tarikh</label>
                            <select id="dateRangeSelect" onchange="handleDateRangeChange()" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300">
                                <option value="all">Semua Tarikh</option>
                                <option value="today">Hari Ini</option>
                                <option value="yesterday">Semalam</option>
                                <option value="last7days">7 Hari Lepas</option>
                                <option value="last30days">30 Hari Lepas</option>
                                <option value="thismonth">Bulan Ini</option>
                                <option value="lastmonth">Bulan Lepas</option>
                                <option value="custom">Pilih Tarikh Sendiri</option>
                            </select>
                        </div>
                        <div id="customDateFrom" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Tarikh Dari</label>
                            <input type="date" id="filterDateFrom" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300">
                        </div>
                        <div id="customDateTo" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Tarikh Hingga</label>
                            <input type="date" id="filterDateTo" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300">
                        </div>
                    </div>
                    <div class="mt-4 flex gap-4">
                        <button onclick="applyDetailedFilter()" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-2 px-6 rounded-lg transition duration-300 glow-effect">
                            Tapis Data
                        </button>
                        <button onclick="clearDetailedFilter()" class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-semibold py-2 px-6 rounded-lg transition duration-300 glow-effect">
                            Reset
                        </button>
                    </div>
                </div>
                
                <!-- Detailed Data Cards -->
                <div id="detailedDataContainer" class="space-y-6">
                    <!-- Data cards will be populated here -->
                </div>
            </div>
        </div>

        <!-- Custom Confirmation Modal (Padam/Delete) -->
        <div id="confirmationModal" class="modal fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none">
            <div class="modal-content bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl p-8 max-w-lg w-full mx-4 border border-gray-700 glow-effect transform scale-95 transition-transform">
                <h3 class="text-2xl font-bold text-red-500 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                    Pengesahan Pemadaman
                </h3>
                <p id="modalMessage" class="text-gray-300 mb-6">Anda pasti mahu memadam rekod ini secara kekal? Tindakan ini tidak boleh ditarik balik.</p>
                <div class="flex justify-end gap-3">
                    <button id="cancelDelete" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-xl transition duration-300">
                        Batal
                    </button>
                    <button id="confirmDelete" data-branch-code="" data-timestamp="" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl transition duration-300 glow-effect">
                        Padam Sekarang
                    </button>
                </div>
            </div>
        </div>


        <!-- Success Notification -->
        <div id="successNotification" class="fixed top-4 right-4 bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-4 rounded-xl shadow-2xl transition-transform duration-500 glow-effect z-50 off-screen-right">
            <div class="flex items-center">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span class="font-semibold">Data berjaya disimpan dan dihantar ke Server!</span>
            </div>
        </div>

        <!-- Error Notification -->
        <div id="errorNotification" class="fixed top-4 right-4 bg-gradient-to-r from-red-600 to-red-700 text-white px-6 py-4 rounded-xl shadow-2xl transition-transform duration-500 glow-effect z-50 off-screen-right">
            <div class="flex items-center">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <span class="font-semibold">Ralat Data dari Server : Ralat memproses permintaan.</span>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="bg-gradient-to-r from-gray-800 to-gray-900 border-t border-gray-700 mt-16">
            <div class="container mx-auto px-6 py-6">
                <p class="text-center text-gray-400 text-sm">Generated using A.I by Jabatan Imigresen Malaysia Negeri Terengganu</p>
            </div>
        </footer>
    </div> <!-- Tutup background-overlay -->

    <script>
        // Google Sheets configuration
        var GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbxt5Fm6mD8Z-J8w0-UJV1GIaDcAajBeRsQKJVEQUTx4VkiZ7Xfpj8q_4fL-JbW38wN44A/exec';
        
        // Global variable to store data fetched from Sheets
        var globalDetailedData = [];

        // User credentials
        const users = {
            'depotajil': 'depotajil123',
            'visapas': 'visapas123',
            'pasport': 'pasport123',
            'pekerjaasing': 'pekerjaasing123',
            'jimbesut': 'jimbesut123',
            'jimchukai': 'jimchukai123',
            'jimdungun': 'jimdungun123',
            'jimkerteh': 'jimkerteh123',
            'pintrg': 'pintrg123',
            'korporat': 'korporat123',
            'admin': 'admin123'
        };
        
        // Branch configurations (Same as in Code.gs)
        const branchConfigs = {
            'DIA': { name: 'Depot Imigresen Ajil (DIA)', fields: [{ title: 'Pergerakan Tahanan Depot Imigresen Ajil (Record Office)', fields: ['Terima OKT Kes Tangkapan (BPK)', 'Terima Banduan Asing (BA) - Marang', 'Terima Banduan Asing (BA) - Satelit', 'Terima Banduan Asing (BA) - Bayar Denda/Mahkamah', 'Pemindahan Keluar (Udara)', 'Pemindahan Keluar (Laut)', 'Pemindahan Keluar (Darat)', 'Bebas OKT (Majikan)', 'Bebas OKT (Pegawai)', 'Pengeluaran OKT - Siasatan', 'Pengeluaran OKT - Dakwa', 'Deposisi', 'OKT Rawatan Klinik Kesihatan', 'Serahan Properties', 'Lokap Sementara (RO)', 'Tahanan Di Wad - HSNZ', 'Tahanan Di Wad - HHT', 'Tahanan Reman (Siasatan)'] }, { title: 'Muster Terkini', fields: ['LELAKI', 'WANITA', 'KANAK-KANAK LELAKI', 'KANAK-KANAK PEREMPUAN', 'MUSTER PENUH', 'BAKI KEKOSONGAN'] }] },
            'G': { name: 'Bahagian Visa, Pas & Permit (G)', fields: [{ title: 'Urusniaga Visa, Pas dan Permit', fields: ['PLS (Baru)', 'PLS (Lanjutan)', 'e-PLSi', 'e-Lanjutan', 'Pas Pelajar', 'Pas Tanggungan/Mengiringi', 'Pas Penggajian/PLIK', 'Pas Residen', 'Permit Masuk', 'Pas Khas (SP)', 'Pindah Pelekat / Pendek Pas', 'Kelayakan Visa', 'Kebenaran Bekerja', 'Tuntutan W/Cagaran', 'Check-out Memo (COM)', 'Notis PR', 'Clearance Visa', 'Pindah Fail', 'Kebenaran Belajar'] }, { title: 'Baki Stok Dokumen', fields: ['MALPASS', 'MALVISA'] }, { title: 'Urusniaga Kutipan Hasil', fields: ['Jumlah Debit (RM)', 'Jumlah Kredit (RM)', 'Jumlah Kutipan (RM)'] }] },
            'H': { name: 'Bahagian Keselamatan & Pasport (H) â€“ UTC Terengganu', fields: [{ title: 'Urusniaga Dokumen Perjalanan', fields: ['Pasport Malaysia Antarabangsa (PMA)', 'Dokumen Perjalanan Terhad (DPT)', 'Surat Akuan Pengenalan (SAP)', 'Sijil Perakuan Cemas (SPC)', 'Kehilangan PMA', 'Kerosakan PMA', 'My Online Pasport', 'Rujukan Sabah (H)', 'Rujukan Sarawak (K)'] }, { title: 'Baki Stok Dokumen', fields: ['PMA POLY', 'IM.89 DPT', 'IM.44 SAP', 'IM.40 SPC'] }, { title: 'Urusniaga Kutipan Hasil', fields: ['Jumlah Debit (RM)', 'Jumlah Kredit (RM)', 'Jumlah Kutipan (RM)'] }] },
            'J': { name: 'Bahagian Pekerja Asing (J)', fields: [{ title: 'Urusniaga Pekerja Asing', fields: ['PLKS Nelayan (Baru)', 'PLKS Nelayan (Lanjutan)', 'PLKS On / OffShore (Baru)', 'PLKS On / OffShore (Lanjutan)', 'PLKS Tomyam (Baru)', 'PLKS Tomyam (Lanjutan)', 'Visa Dengan Rujukan (VDR)', 'Pas Khas (SP)', 'Check-Out Memo (COM)'] }, { title: 'Baki Stok Dokumen', fields: ['MALPASS', 'MALVISA'] }, { title: 'Urusniaga Kutipan Hasil', fields: ['Jumlah Debit (RM)', 'Jumlah Kredit (RM)', 'Jumlah Kutipan (RM)'] }] },
            'BESUT': { name: 'Pejabat Imigresen Besut', fields: [{ title: 'Urusniaga Dokumen Perjalanan', fields: ['Pasport Malaysia Antarabangsa (PMA)', 'Dokumen Perjalanan Terhad (DPT)', 'Surat Akuan Pengenalan (SAP)', 'Sijil Perakuan Cemas (SPC)', 'Kehilangan PMA', 'Kerosakan PMA', 'My Online Pasport', 'Rujukan Sabah (H)', 'Rujukan Sarawak (K)'] }, { title: 'Urusniaga Visa, Pas dan Permit', fields: ['PLS (Baru)', 'PLS (Lanjutan)', 'e-PLSi', 'Pas Pelajar', 'Pas Residen', 'Permit Masuk', 'Pas Khas (SP)', 'Pindah Pelekat / Pendek Pas', 'Kelayakan Visa', 'Kebenaran Bekerja', 'Tuntutan W/Cagaran', 'Pindah Fail'] }, { title: 'Baki Stok Dokumen', fields: ['PMA POLY', 'IM.89 DPT', 'IM.44 SAP', 'IM.40 SPC', 'MALPASS', 'MALVISA'] }, { title: 'Urusniaga Kutipan Hasil', fields: ['Jumlah Debit (RM)', 'Jumlah Kredit (RM)', 'Jumlah Kutipan (RM)'] }] },
            'CHUKAI': { name: 'Pejabat Imigresen Chukai', fields: [{ title: 'Urusniaga Dokumen Perjalanan', fields: ['Pasport Malaysia Antarabangsa (PMA)', 'Dokumen Perjalanan Terhad (DPT)', 'Surat Akuan Pengenalan (SAP)', 'Sijil Perakuan Cemas (SPC)', 'Kehilangan PMA', 'Kerosakan PMA', 'My Online Pasport', 'Rujukan Sabah (H)', 'Rujukan Sarawak (K)'] }, { title: 'Urusniaga Visa, Pas dan Permit', fields: ['PLS (Baru)', 'PLS (Lanjutan)', 'e-PLSi', 'Pas Pelajar', 'Pas Residen', 'Permit Masuk', 'Pas Khas (SP)', 'Pindah Pelekat / Pendek Pas', 'Kelayakan Visa', 'Kebenaran Bekerja', 'Tuntutan W/Cagaran', 'Pindah Fail'] }, { title: 'Baki Stok Dokumen', fields: ['PMA POLY', 'IM.89 DPT', 'IM.44 SAP', 'IM.40 SPC', 'MALPASS', 'MALVISA'] }, { title: 'Urusniaga Kutipan Hasil', fields: ['Jumlah Debit (RM)', 'Jumlah Kredit (RM)', 'Jumlah Kutipan (RM)'] }] },
            'DUNGUN': { name: 'Pejabat Imigresen Dungun', fields: [{ title: 'Urusniaga Dokumen Perjalanan', fields: ['Pasport Malaysia Antarabangsa (PMA)', 'Dokumen Perjalanan Terhad (DPT)', 'Kehilangan PMA', 'Kerosakan PMA', 'Rujukan Sabah (H)', 'Rujukan Sarawak (K)'] }, { title: 'Urusniaga Visa, Pas dan Permit', fields: ['PLS (Baru)', 'PLS (Lanjutan)', 'e-PLSi', 'Pas Pelajar', 'Pas Residen', 'Permit Masuk', 'Pas Khas (SP)', 'Pindah Pelekat / Pendek Pas', 'Kelayakan Visa', 'Kebenaran Bekerja', 'Tuntutan W/Cagaran', 'Pindah Fail'] }, { title: 'Baki Stok Dokumen', fields: ['IM.89 DPT', 'MALPASS', 'MALVISA'] }, { title: 'Urusniaga Kutipan Hasil', fields: ['Jumlah Debit (RM)', 'Jumlah Kredit (RM)', 'Jumlah Kutipan (RM)'] }] },
            'KERTEH': { name: 'Pejabat Imigresen Kerteh', fields: [{ title: 'Urusniaga Dokumen Perjalanan', fields: ['Pasport Malaysia Antarabangsa (PMA)', 'Dokumen Perjalanan Terhad (DPT)', 'Kehilangan PMA', 'Kerosakan PMA', 'My Online Pasport', 'Rujukan Sabah (H)', 'Rujukan Sarawak (K)'] }, { title: 'Urusniaga Visa, Pas dan Permit', fields: ['PLS (Baru)', 'PLS (Lanjutan)', 'e-PLSi', 'Pas Pelajar', 'Pas Residen', 'Permit Masuk', 'Pas Khas (SP)', 'Pindah Pelekat / Pendek Pas', 'Kelayakan Visa', 'Kebenaran Bekerja', 'Tuntutan W/Cagaran', 'Pindah Fail'] }, { title: 'Baki Stok Dokumen', fields: ['IM.89 DPT', 'MALPASS', 'MALVISA'] }, { title: 'Urusniaga Kutipan Hasil', fields: ['Jumlah Debit (RM)', 'Jumlah Kredit (RM)', 'Jumlah Kutipan (RM)'] }] }
        };

        // Check if user is logged in
        function checkAuth() {
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                showMainApp();
                document.getElementById('currentUser').textContent = `Pengguna: ${currentUser}`;
            } else {
                showLoginPage();
            }
        }
        
        // Show login page
        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainHeader').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
        }
        
        // Show main application
        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainHeader').classList.remove('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('homePage').classList.remove('hidden');
            document.getElementById('dataEntryPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.add('hidden');
            document.getElementById('dataTerinciPage').classList.add('hidden');
            
            // Set today's date as default
            if (document.getElementById('dateInput')) {
                document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
            }
        }
        
        // Handle login
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('loginButton');
            const loginButtonText = document.getElementById('loginButtonText');
            const loginSpinner = document.getElementById('loginSpinner');
            const loginError = document.getElementById('loginError');
            
            // Hide error message
            loginError.classList.add('hidden');
            
            // Show loading state
            loginButton.disabled = true;
            loginButtonText.textContent = 'Mengesahkan...';
            loginSpinner.classList.remove('hidden');
            
            // Simulate authentication delay
            setTimeout(() => {
                if (users[username] && users[username] === password) {
                    // Successful login
                    localStorage.setItem('currentUser', username);
                    showMainApp();
                    document.getElementById('currentUser').textContent = `Pengguna: ${username}`;
                    
                    // Reset form
                    document.getElementById('loginForm').reset();
                } else {
                    // Failed login
                    loginError.classList.remove('hidden');
                }
                
                // Reset button state
                loginButton.disabled = false;
                loginButtonText.textContent = 'Log Masuk';
                loginSpinner.classList.add('hidden');
            }, 1000);
        });
        
        // Logout function
        function logout() {
            localStorage.removeItem('currentUser');
            showLoginPage();
        }
        
        // Initialize app
        checkAuth();
        
        // Handle form submission for branch selection
        document.getElementById('entryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const branch = document.getElementById('branchSelect').value;
            const date = document.getElementById('dateInput').value;
            
            if (!branch) {
                // Menggantikan alert()
                showErrorNotification('Sila pilih cawangan');
                return;
            }
            
            showDataEntry(branch, date);
        });
        
        function showDataEntry(branch, date) {
            const config = branchConfigs[branch];
            if (!config) {
                // Menggantikan alert()
                showErrorNotification('Cawangan ini belum disediakan');
                return;
            }
            
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('dataEntryPage').classList.remove('hidden');
            document.getElementById('branchTitle').textContent = config.name;
            document.getElementById('selectedDate').textContent = `Tarikh: ${new Date(date).toLocaleDateString('ms-MY')}`;
            
            // Generate form fields
            const formFields = document.getElementById('formFields');
            formFields.innerHTML = '';
            
            config.fields.forEach((section, sectionIndex) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'bg-gradient-to-br from-gray-700 to-gray-800 p-8 rounded-2xl mb-8 border border-gray-600 glow-effect';
                
                const sectionTitle = document.createElement('h3');
                sectionTitle.className = 'text-2xl font-bold gradient-text mb-6';
                sectionTitle.textContent = section.title;
                sectionDiv.appendChild(sectionTitle);
                
                const fieldsGrid = document.createElement('div');
                fieldsGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-6';
                
                section.fields.forEach((field, fieldIndex) => {
                    const fieldDiv = document.createElement('div');
                    
                    const label = document.createElement('label');
                    label.className = 'block text-lg font-medium text-gray-300 mb-2';
                    label.textContent = field;
                    
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.min = '0';
                    input.className = 'w-full px-4 py-3 bg-gray-600 border border-gray-500 rounded-xl text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300';
                    input.name = `${branch}_${sectionIndex}_${fieldIndex}`;
                    input.value = '0';
                    
                    // Auto calculation for specific fields
                    if (field === 'Jumlah Kutipan (RM)' || field === 'MUSTER PENUH' || field === 'BAKI KEKOSONGAN') {
                        input.readOnly = true;
                        input.className += ' bg-gray-500 cursor-not-allowed';
                    }
                    
                    // Add event listeners for auto calculation
                    if (section.title === 'Urusniaga Kutipan Hasil' && (field === 'Jumlah Debit (RM)' || field === 'Jumlah Kredit (RM)')) {
                        input.addEventListener('input', function() {
                            calculateKutipan(branch, sectionIndex);
                        });
                    }
                    
                    if (section.title === 'Muster Terkini' && ['LELAKI', 'WANITA', 'KANAK-KANAK LELAKI', 'KANAK-KANAK PEREMPUAN'].includes(field)) {
                        input.addEventListener('input', function() {
                            calculateMuster(branch, sectionIndex);
                        });
                    }
                    
                    fieldDiv.appendChild(label);
                    fieldDiv.appendChild(input);
                    fieldsGrid.appendChild(fieldDiv);
                });
                
                sectionDiv.appendChild(fieldsGrid);
                formFields.appendChild(sectionDiv);
            });
            
            // Store current branch and date
            document.getElementById('dataForm').dataset.branch = branch;
            document.getElementById('dataForm').dataset.date = date;
        }
        
        // Google Sheets configuration
        var GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbxt5Fm6mD8Z-J8w0-UJV1GIaDcAajBeRsQKJVEQUTx4VkiZ7Xfpj8q_4fL-JbW38wN44A/exec';
        
        // Handle data form submission
        document.getElementById('dataForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show loading state
            const saveButton = document.getElementById('saveButton');
            const saveButtonText = document.getElementById('saveButtonText');
            const saveSpinner = document.getElementById('saveSpinner');
            
            saveButton.disabled = true;
            saveButtonText.textContent = 'Menyimpan...';
            saveSpinner.classList.remove('hidden');
            
            // Start processing immediately (removed setTimeout)
            const branch = this.dataset.branch;
            const date = this.dataset.date;
            const formData = new FormData(this);
            const currentUser = localStorage.getItem('currentUser');
            
            const data = {
                branch: branch,
                branchName: branchConfigs[branch].name,
                date: date,
                timestamp: new Date().toISOString(), // FIXED: Use ISO String for consistent Sheets storage
                user: currentUser,
                values: {}
            };
            
            // Collect all form values
            for (let [key, value] of formData.entries()) {
                data.values[key] = parseFloat(value) || 0;
            }
            
            // Calculate totals for specific branches
            if (branch === 'DIA') {
                // Get muster data from calculated fields
                data.musterPenuh = data.values[`${branch}_1_4`] || 0;
                data.kekosongan = data.values[`${branch}_1_5`] || 0;
            }
            
            // Collect Kutipan Hasil
            const isRegionalBranch = ['BESUT', 'CHUKAI', 'DUNGUN', 'KERTEH'].includes(branch);
            const kutipanSectionIndex = isRegionalBranch ? 3 : 2;
            const debit = data.values[`${branch}_${kutipanSectionIndex}_0`] || 0;
            const kredit = data.values[`${branch}_${kutipanSectionIndex}_1`] || 0;
            data.kutipanHasil = debit + kredit;
            
            // Collect PMA for Passport/Regional
            if (['H', 'BESUT', 'CHUKAI', 'DUNGUN', 'KERTEH'].includes(branch)) {
                data.pma = data.values[`${branch}_0_0`] || 0;
            }

            // Send to Google Sheets
            sendToGoogleSheets(data).then(() => {
                // Reset form fields to 0 after successful submission
                this.reset(); 
                document.querySelectorAll('#formFields input[type="number"]').forEach(input => input.value = '0');

                // Reset button state
                saveButton.disabled = false;
                saveButtonText.textContent = 'Simpan Data';
                saveSpinner.classList.add('hidden');
                
                // Show success notification
                showSuccessNotification('Data berjaya disimpan dan dihantar ke Server!');

                // NOTA: Kemaskini Dashboard secara automatik selepas simpan
                viewDashboard(); 
            }).catch((error) => {
                // Reset button state
                saveButton.disabled = false;
                saveButtonText.textContent = 'Simpan Data';
                saveSpinner.classList.add('hidden');
                
                // Show error notification
                showErrorNotification(`Ralat Data dari Server : ${error}`);
            });
        });
        
        function calculateKutipan(branch, sectionIndex) {
            const debitInput = document.querySelector(`input[name="${branch}_${sectionIndex}_0"]`);
            const kreditInput = document.querySelector(`input[name="${branch}_${sectionIndex}_1"]`);
            const totalInput = document.querySelector(`input[name="${branch}_${sectionIndex}_2"]`);
            
            if (debitInput && kreditInput && totalInput) {
                const debit = parseFloat(debitInput.value) || 0;
                const kredit = parseFloat(kreditInput.value) || 0;
                totalInput.value = (debit + kredit).toFixed(2); // Format as currency
            }
        }
        
        function calculateMuster(branch, sectionIndex) {
            const lelakiInput = document.querySelector(`input[name="${branch}_${sectionIndex}_0"]`);
            const wanitaInput = document.querySelector(`input[name="${branch}_${sectionIndex}_1"]`);
            const kanakLelakiInput = document.querySelector(`input[name="${branch}_${sectionIndex}_2"]`);
            const kanakPerempuanInput = document.querySelector(`input[name="${branch}_${sectionIndex}_3"]`);
            const musterPenuhInput = document.querySelector(`input[name="${branch}_${sectionIndex}_4"]`);
            const bakiKekosonganInput = document.querySelector(`input[name="${branch}_${sectionIndex}_5"]`);
            
            if (lelakiInput && wanitaInput && kanakLelakiInput && kanakPerempuanInput && musterPenuhInput && bakiKekosonganInput) {
                const lelaki = parseFloat(lelakiInput.value) || 0;
                const wanita = parseFloat(wanitaInput.value) || 0;
                const kanakLelaki = parseFloat(kanakLelakiInput.value) || 0;
                const kanakPerempuan = parseFloat(kanakPerempuanInput.value) || 0;
                
                const musterPenuh = lelaki + wanita + kanakLelaki + kanakPerempuan;
                const bakiKekosongan = 900 - musterPenuh;
                
                musterPenuhInput.value = musterPenuh;
                bakiKekosonganInput.value = bakiKekosongan;
            }
        }
        
        // Send data to Google Sheets (used for both submit and delete)
        async function sendToGoogleSheets(data) {
            try {
                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        // Menggunakan text/plain untuk Apps Script lebih konsisten dengan no-cors
                        'Content-Type': 'text/plain', 
                    },
                    body: JSON.stringify(data)
                });
                
                // Since mode is 'no-cors', we can't read the response object accurately.
                    // We assume success if no network error is thrown.
                console.log('Data sent to Google Sheets successfully');
                return Promise.resolve();
                
            } catch (error) {
                console.error('Error sending to Google Sheets:', error);
                // Return a clear error message for the frontend notification
                throw error.message || 'Gagal menghantar ke Google Sheets (Ralat Rangkaian)';
            }
        }
        
        function showSuccessNotification(message = 'Data berjaya disimpan dan dihantar ke Server!') {
            const notification = document.getElementById('successNotification');
            const messageElement = notification.querySelector('span');
            messageElement.textContent = message;
            
            // REMOVE custom class to slide in (show)
            notification.classList.remove('off-screen-right');
            
            setTimeout(() => {
                // ADD custom class to slide out (hide)
                notification.classList.add('off-screen-right');
            }, 4000);
        }
        
        function showErrorNotification(message) {
            const errorNotification = document.getElementById('errorNotification');
            const messageElement = errorNotification.querySelector('span');
            
            // FIX: Use Ralat Data dari Server prefix
            const displayMessage = message.startsWith('Ralat Google Sheets:') ? message.replace('Ralat Google Sheets:', 'Ralat Data dari Server :') : message;
            messageElement.textContent = displayMessage;
            
            // REMOVE custom class to slide in (show)
            errorNotification.classList.remove('off-screen-right');
            
            setTimeout(() => {
                // ADD custom class to slide out (hide)
                errorNotification.classList.add('off-screen-right');
            }, 5000);
        }
        
        // --- REAL-TIME FETCH LOGIC STARTS HERE ---
        
        /**
         * Mengambil data ringkasan terkini dari Google Sheets (doGet) dan memaparkan Dashboard.
         */
        async function fetchDashboardData(dateFilter = null) {
            
            // 1. Tunjukkan loading state
            document.getElementById('totalPMA').textContent = '...';
            document.getElementById('totalRevenue').textContent = 'RM ...';
            document.getElementById('dashboardStats').classList.add('opacity-50', 'pointer-events-none');
            // Tunjukkan spinner loading
            document.getElementById('loadingMessage').classList.remove('hidden');
            document.getElementById('stockCardsContainer').classList.add('hidden');
            
            let fetchUrl = GOOGLE_SHEETS_URL + '?action=getDashboardData';
            if (dateFilter) {
                fetchUrl += `&date=${dateFilter}`;
            }

            try {
                const response = await fetch(fetchUrl);
                
                // Google Apps Script returns JSON with Content-Type: text/html, so we must parse it carefully
                const text = await response.text();
                const result = JSON.parse(text);

                if (result.status === 'error') {
                    throw new Error(result.message || 'Gagal mengambil data dari Apps Script.');
                }

                // Simpan data mentah terkini di global variable untuk Detail Page filtering
                globalDetailedData = result.detailedData || [];
                
                // Gunakan data ringkasan terus untuk Dashboard
                updateDashboard(result.dashboard, dateFilter); 
                
            } catch (error) {
                console.error('Ralat semasa fetching dashboard data:', error);
                // FIX: Gunakan format ralat baharu
                showErrorNotification(`Ralat Data dari Server : ${error.message || 'Ralat rangkaian.'}. Memaparkan data 0.`);
                
                // Paparkan data 0 jika fetch gagal total
                updateDashboard(null); 
            } finally {
                // Sembunyikan loading state
                document.getElementById('loadingMessage').classList.add('hidden');
                document.getElementById('stockCardsContainer').classList.remove('hidden');
                document.getElementById('dashboardStats').classList.remove('opacity-50', 'pointer-events-none');
            }
        }
        
        function viewDashboard() {
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('dataEntryPage').classList.add('hidden');
            document.getElementById('dataTerinciPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.remove('hidden');
            
            // Set current date as default
            document.getElementById('dashboardDateFilter').value = new Date().toISOString().split('T')[0];
            
            // FIX: Panggil fetchDashboardData dengan tarikh hari ini
            const todayDate = document.getElementById('dashboardDateFilter').value;
            fetchDashboardData(todayDate);
        }
        
        function updateDashboard(serverData, dateFilter = null) {
            
            if (!serverData) {
                // Fallback jika fetch gagal total
                serverData = {
                    totalPMA: 0, totalRevenue: 0, totalMuster: 0, totalVacancy: 0,
                    totalPolyStock: 0, totalDptStock: 0, totalSapStock: 0, totalSpcStock: 0,
                    totalMalpassStock: 0, totalMalvisaStock: 0,
                    branchSummary: {}
                };
            }
            
            // Check for No Data / Filter scenario
            const isFiltered = dateFilter && dateFilter.length > 0;
            const isTotallyEmpty = serverData.totalPMA === 0 && serverData.totalRevenue === 0 && serverData.totalMuster === 0 && serverData.totalRevenue === 0;

            if (isFiltered && isTotallyEmpty) {
                // FIX: Notifikasi tepat untuk data kosong
                showErrorNotification('Tiada data atau laporan pada tarikh yang dipilih!');
            }

            // 1. Dapatkan data ringkasan
            const {
                totalPMA, totalRevenue, totalMuster, totalVacancy,
                totalPolyStock, totalDptStock, totalSapStock, totalSpcStock,
                totalMalpassStock, totalMalvisaStock, branchSummary
            } = serverData;
            
            // 2. Update summary cards
            document.getElementById('totalPMA').textContent = totalPMA.toLocaleString();
            document.getElementById('totalRevenue').textContent = `RM ${totalRevenue.toLocaleString()}`;
            document.getElementById('totalMuster').textContent = totalMuster.toLocaleString();
            document.getElementById('totalVacancy').textContent = totalVacancy.toLocaleString();
            
            // 3. Update stock cards
            document.getElementById('totalPolyStock').textContent = totalPolyStock.toLocaleString();
            document.getElementById('totalDptStock').textContent = totalDptStock.toLocaleString();
            document.getElementById('totalSapStock').textContent = totalSapStock.toLocaleString();
            document.getElementById('totalSpcStock').textContent = totalSpcStock.toLocaleString();
            document.getElementById('totalMalpassStock').textContent = totalMalpassStock.toLocaleString();
            document.getElementById('totalMalvisaStock').textContent = totalMalvisaStock.toLocaleString();
            
            // 4. Update table (menggunakan data yang dikira dari Apps Script)
            updateDataTable(branchSummary);
        }
        
        function updateDataTable(branchData) {
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = '';
            
            // FIX: Ensure branchData is iterable
            if (!branchData) {
                console.error("branchData is null or undefined in updateDataTable.");
                return;
            }

            // List of branches to display (excluding DIA)
            const branchDisplayOrder = [
                'Bahagian Visa, Pas & Permit (G)',
                'Bahagian Pekerja Asing (J)',
                'Bahagian Keselamatan & Pasport (H) â€“ UTC Terengganu',
                'Pejabat Imigresen Besut',
                'Pejabat Imigresen Chukai',
                'Pejabat Imigresen Dungun',
                'Pejabat Imigresen Kerteh'
            ];

            const cawanganMap = {
                'Bahagian Visa, Pas & Permit (G)': 'VPP',
                'Bahagian Pekerja Asing (J)': 'BPA',
                'Bahagian Keselamatan & Pasport (H) â€“ UTC Terengganu': 'PASPORT',
                'Pejabat Imigresen Besut': 'BESUT',
                'Pejabat Imigresen Chukai': 'CHUKAI',
                'Pejabat Imigresen Dungun': 'DUNGUN',
                'Pejabat Imigresen Kerteh': 'KERTEH'
            };

            branchDisplayOrder.forEach(fullBranchName => {
                const data = branchData[fullBranchName] || {};
                const displayBranchName = cawanganMap[fullBranchName] || fullBranchName;

                // Data is retrieved directly from server-calculated totals
                const urusniagaValue = data.totalUrusniaga || 0; 
                
                // Set default values to 0 if data doesn't exist for the branch
                const pmaValue = data.pma || 0;
                const polyValue = data.poly || 0;
                const dptValue = data.dpt || 0;
                const sapValue = data.sap || 0;
                const spcValue = data.spc || 0;
                const malpassValue = data.malpass || 0;
                const malvisaValue = data.malvisa || 0;
                const kutipanValue = data.kutipan || 0;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700 transition duration-300';
                
                row.innerHTML = `
                    <td class="px-1 py-2 whitespace-nowrap text-xs font-medium text-blue-400 text-center">${displayBranchName}</td>
                    <td class="px-1 py-2 whitespace-nowrap text-xs text-gray-300 text-center">${urusniagaValue.toLocaleString()}</td>
                    <td class="px-1 py-2 whitespace-nowrap text-xs text-gray-300 text-center">${pmaValue.toLocaleString()}</td>
                    <td class="px-1 py-2 whitespace-nowrap text-xs text-gray-300 text-center">${polyValue.toLocaleString()}</td>
                    <td class="px-1 py-2 whitespace-nowrap text-xs text-gray-300 text-center">${dptValue.toLocaleString()}</td>
                    <td class="px-1 py-2 whitespace-nowrap text-xs text-gray-300 text-center">${sapValue.toLocaleString()}</td>
                    <td class="px-1 py-2 whitespace-nowrap text-xs text-gray-300 text-center">${spcValue.toLocaleString()}</td>
                    <td class="px-1 py-2 whitespace-nowrap text-xs text-gray-300 text-center">${malpassValue.toLocaleString()}</td>
                    <td class="px-1 py-2 whitespace-nowrap text-xs text-gray-300 text-center">${malvisaValue.toLocaleString()}</td>
                    <td class="px-1 py-2 whitespace-nowrap text-xs text-green-400 font-semibold text-center">RM ${kutipanValue.toLocaleString()}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        function filterByDate() {
            const selectedDate = document.getElementById('dashboardDateFilter').value;
            // viewDashboard will automatically handle the fetch with the new date
            fetchDashboardData(selectedDate);
        }
        
        function goHome() {
            document.getElementById('dataEntryPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.add('hidden');
            document.getElementById('dataTerinciPage').classList.add('hidden');
            document.getElementById('homePage').classList.remove('hidden');
        }
        
        // DATA TERPERINCI LOGIC
        
        /**
         * Mengambil semua rekod dari Sheets untuk halaman Data Terperinci.
         */
        async function fetchAllDetailedData() {
            const container = document.getElementById('detailedDataContainer');
            container.innerHTML = `<div id="dataDetailedLoading" class="text-center text-gray-400 py-10">
                <div class="spinner mx-auto mb-4"></div>
                Memuatkan semua rekod dari Server...
            </div>`;

            let fetchUrl = GOOGLE_SHEETS_URL + '?action=getDashboardData';
            
            try {
                const response = await fetch(fetchUrl);
                const text = await response.text();
                const result = JSON.parse(text);

                if (result.status === 'error') {
                    throw new Error(result.message || 'Gagal mengambil data dari Apps Script.');
                }
                
                // Simpan data mentah terkini di global variable untuk Detail Page filtering
                globalDetailedData = result.detailedData || [];
                
                // Muatkan data ke dalam kad
                loadDetailedData(globalDetailedData);

            } catch (error) {
                console.error('Ralat semasa fetching all detailed data:', error);
                // FIX: Gunakan format ralat baharu
                container.innerHTML = `
                    <div class="bg-gradient-to-br from-red-800 to-red-900 rounded-2xl shadow-2xl p-8 text-center border border-red-700 glow-effect">
                        <div class="text-6xl mb-4 text-red-400">âŒ</div>
                        <h3 class="text-2xl font-bold text-red-400 mb-2">Ralat Memuatkan Data</h3>
                        <p class="text-red-300">Ralat Data dari Server : ${error.message || 'Ralat rangkaian.'}. Sila semak konsol untuk maklumat lanjut.</p>
                    </div>
                `;
            }
        }
        
        async function viewDataTerperinci() {
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('dataEntryPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.add('hidden');
            document.getElementById('dataTerinciPage').classList.remove('hidden');

            // FIX: Set default filter to 'today' and apply
            const todayDate = new Date().toISOString().split('T')[0];
            document.getElementById('dateRangeSelect').value = 'today';
            document.getElementById('filterDateFrom').value = todayDate;
            document.getElementById('filterDateTo').value = todayDate;
            
            // Panggil fungsi untuk mengambil semua data dari Sheets untuk halaman Terperinci
            await fetchAllDetailedData();
            
            // Apply current filters or load all if no filters applied yet
            applyDetailedFilter();
        }
        
        function loadDetailedData(filteredData = null) {
            const dataToShow = filteredData; 
            const container = document.getElementById('detailedDataContainer');
            container.innerHTML = '';
            
            if (!dataToShow || dataToShow.length === 0) {
                container.innerHTML = `
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl p-8 text-center border border-gray-700 glow-effect">
                        <div class="text-6xl mb-4">ðŸ“Š</div>
                        <h3 class="text-2xl font-bold gradient-text mb-2">Tiada Data</h3>
                        <p class="text-gray-300">Belum ada data yang dimasukkan atau tidak memenuhi kriteria penapis.</p>
                    </div>
                `;
                return;
            }
            
            // Sort data by date (newest first)
            dataToShow.sort((a, b) => new Date(b['Tarikh Entri']) - new Date(a['Tarikh Entri']));
            
            dataToShow.forEach(record => {
                const cawangan = record['Kod Cawangan'];
                const branchName = record['Cawangan'];
                
                // FIX 1: Clean up date and time display
                const rawDate = record['Tarikh Entri']; // Data key from Sheets must remain 'Tarikh Entri'
                const rawTimestamp = record['Masa Capaian'];

                // Format Tarikh Entri: Ambil YYYY-MM-DD sahaja dari string ISO atau Date Object
                let displayDate = rawDate;
                if (typeof rawDate === 'string' && rawDate.includes('T')) {
                    displayDate = rawDate.split('T')[0];
                } else if (rawDate instanceof Date) {
                    displayDate = rawDate.toISOString().split('T')[0];
                } else if (typeof rawDate === 'string' && !rawDate.includes('T')) {
                    displayDate = rawDate;
                }
                
                // PENAMBAHBAIKAN: Tukar format YYYY-MM-DD kepada DD/MM/YYYY
                if (typeof displayDate === 'string' && displayDate.includes('-')) {
                    const parts = displayDate.split('-'); // [YYYY, MM, DD]
                    if (parts.length === 3) {
                        displayDate = `${parts[2]}/${parts[1]}/${parts[0]}`; // DD/MM/YYYY
                    }
                }
                
                // Masa Capaian: Paparkan string sedia ada yang disimpan oleh Apps Script
                const displayTimestamp = rawTimestamp || '-';

                const config = branchConfigs[cawangan];
                if (!config) return;

                let sectionsHTML = '';
                
                config.fields.forEach((section) => {
                    let fieldsHtml = '';

                    section.fields.forEach((field) => {
                        const friendlyHeader = `${branchName} - ${section.title} - ${field}`;
                        // Get value directly from the flat record using the full header name
                        let value = record[friendlyHeader] || 0;
                        
                        // Ensure value is treated as string/number for formatting
                        if (typeof value === 'object' && value instanceof Date) {
                             value = value.toISOString().split('T')[0];
                        }
                        
                        const displayValue = field.includes('(RM)') ? `RM ${value.toLocaleString()}` : value.toLocaleString();
                        
                        fieldsHtml += `
                            <div class="bg-gray-700 rounded-lg p-3">
                                <p class="text-xs text-gray-400 mb-1">${field}</p>
                                <p class="text-sm font-semibold text-white">${displayValue}</p>
                            </div>
                        `;
                    });
                    
                    sectionsHTML += `
                        <div class="mb-6">
                            <h4 class="text-lg font-bold text-blue-400 mb-3">${section.title}</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                ${fieldsHtml}
                            </div>
                        </div>
                    `;
                });
                
                const card = document.createElement('div');
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold gradient-text">${branchName}</h3>
                            <p class="text-gray-300">Tarikh Laporan: ${displayDate}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-400">Dimasukkan pada</p>
                            <p class="text-sm text-gray-300">${displayTimestamp}</p>
                        </div>
                    </div>
                    
                    ${sectionsHTML}
                    
                    <!-- BUTANG PADAM / DELETE -->
                    <div class="flex justify-end mt-4">
                         <button onclick="deleteRecord(this)" 
                                 data-branch-code="${record['Kod Cawangan']}"
                                 data-timestamp="${record['Masa Capaian']}"
                                 data-branch-name="${branchName}"
                                 data-date-entry="${displayDate}"
                                 class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-xl transition duration-300 glow-effect flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            Padam
                        </button>
                    </div>
                `;
                card.className = 'bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl p-6 border border-gray-700 glow-effect card-hover';
                
                container.appendChild(card);
            });
        }
        
        function applyDetailedFilter() {
            // We use the global copy (globalDetailedData) saved during the last fetch
            const dataToFilter = globalDetailedData; 
            const branch = document.getElementById('filterBranch').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            
            let filteredData = dataToFilter;
            
            if (branch) {
                // Filter based on the 'Kod Cawangan' field from the flat record
                filteredData = filteredData.filter(data => data['Kod Cawangan'] === branch);
            }
            
            if (dateFrom) {
                // Filter based on 'Tarikh Entri' field
                filteredData = filteredData.filter(data => {
                    const recordDate = data['Tarikh Entri'];
                    // FIX: Ensure date is treated as string for comparison
                    return recordDate && new Date(recordDate).toISOString().split('T')[0] >= dateFrom;
                });
            }
            
            if (dateTo) {
                filteredData = filteredData.filter(data => {
                    const recordDate = data['Tarikh Entri'];
                    // FIX: Ensure date is treated as string for comparison
                    return recordDate && new Date(recordDate).toISOString().split('T')[0] <= dateTo;
                });
            }
            
            loadDetailedData(filteredData);
        }
        
        function clearDetailedFilter() {
            document.getElementById('filterBranch').value = '';
            document.getElementById('dateRangeSelect').value = 'all';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('customDateFrom').classList.add('hidden');
            document.getElementById('customDateTo').classList.add('hidden');
            
            // Reload original global data after clearing filters
            loadDetailedData(globalDetailedData);
        }
        
        function handleDateRangeChange() {
            const selectedRange = document.getElementById('dateRangeSelect').value;
            const customDateFrom = document.getElementById('customDateFrom');
            const customDateTo = document.getElementById('customDateTo');
            const filterDateFrom = document.getElementById('filterDateFrom');
            const filterDateTo = document.getElementById('filterDateTo');
            
            if (selectedRange === 'custom') {
                customDateFrom.classList.remove('hidden');
                customDateTo.classList.remove('hidden');
                return;
            } else {
                customDateFrom.classList.add('hidden');
                customDateTo.classList.add('hidden');
            }
            
            const today = new Date();
            let fromDate, toDate;
            
            switch (selectedRange) {
                case 'today':
                    fromDate = toDate = today.toISOString().split('T')[0];
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    fromDate = toDate = yesterday.toISOString().split('T')[0];
                    break;
                case 'last7days':
                    const sevenDaysAgo = new Date(today);
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    fromDate = sevenDaysAgo.toISOString().split('T')[0];
                    toDate = today.toISOString().split('T')[0];
                    break;
                case 'last30days':
                    const thirtyDaysAgo = new Date(today);
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    fromDate = thirtyDaysAgo.toISOString().split('T')[0];
                    toDate = today.toISOString().split('T')[0];
                    break;
                case 'thismonth':
                    fromDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    toDate = today.toISOString().split('T')[0];
                    break;
                case 'lastmonth':
                    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                    fromDate = lastMonth.toISOString().split('T')[0];
                    toDate = lastMonthEnd.toISOString().split('T')[0];
                    break;
                case 'all':
                default:
                    fromDate = toDate = '';
                    break;
            }
            
            filterDateFrom.value = fromDate;
            filterDateTo.value = toDate;
            
            // Auto apply filter when range is selected
            if (selectedRange !== 'custom') {
                applyDetailedFilter();
            }
        }
        
        // DELETE LOGIC START //
        var recordToDelete = {}; // Use a dedicated object for temporary deletion data

        function showConfirmModal(data) {
            // PENTING: Ambil data terus dari attributes butang (this)
            const branchName = data.dataset.branchName;
            const displayDate = data.dataset.dateEntry;
            const branchCode = data.dataset.branchCode;
            const timestamp = data.dataset.timestamp;

            // Simpan data unik ke objek global sementara
            recordToDelete = { branchCode, timestamp, branchName, displayDate };

            // Pautkan data ke butang confirm untuk akses pantas (Optional, tapi lebih bersih)
            const confirmBtn = document.getElementById('confirmDelete');
            confirmBtn.dataset.branchCode = branchCode;
            confirmBtn.dataset.timestamp = timestamp;

            // KEMASKINI: Ubah 'Tarikh:' kepada 'Tarikh Laporan:'
            document.getElementById('modalMessage').textContent = `Anda pasti mahu memadam rekod ini secara kekal? Cawangan: ${branchName} pada Tarikh Laporan: ${displayDate}. Tindakan ini tidak boleh ditarik balik.`;
            
            const modal = document.getElementById('confirmationModal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
        }

        function hideConfirmModal() {
            const modal = document.getElementById('confirmationModal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.classList.remove('opacity-100');
            // Bersihkan data selepas modal ditutup
            recordToDelete = {};
        }

        document.getElementById('cancelDelete').addEventListener('click', hideConfirmModal);
        
        document.getElementById('confirmDelete').addEventListener('click', async function() {
            // Guna data dari objek sementara yang dijamin wujud selepas modal dibuka
            const { branchCode, timestamp, branchName } = recordToDelete;
            
            // PENTING: Semakan terakhir untuk mengelakkan ralat null yang berulang
            if (!branchCode || !timestamp) {
                 showErrorNotification('Ralat: Maklumat pemadaman tidak lengkap. Sila muat semula halaman.');
                 hideConfirmModal();
                 return;
            }

            hideConfirmModal();
            // Tunjukkan loading pada kawasan kad detail
            document.getElementById('detailedDataContainer').innerHTML = `<div class="text-center text-gray-400 py-10"><div class="spinner mx-auto mb-4"></div>Memadam rekod...</div>`;


            const deleteData = {
                action: 'delete',
                branch: branchCode,
                branchName: branchName,
                timestamp: timestamp, 
            };

            try {
                await sendToGoogleSheets(deleteData);
                showSuccessNotification('Rekod berjaya dipadam dari Server!');
                
                // Muat semula data terperinci selepas pemadaman berjaya (untuk mengemas kini paparan)
                await fetchAllDetailedData();
                applyDetailedFilter(); // Tapis semula data yang baru dimuatkan

            } catch (error) {
                showErrorNotification(`Ralat Data dari Server : ${error.message || 'Gagal memadam rekod.'}`);
                // Muat semula data jika gagal untuk menunjukkan status sedia ada
                await fetchAllDetailedData();
                applyDetailedFilter();
            }
        });

        // Diaktifkan oleh butang 'Padam' pada setiap kad data terperinci
        function deleteRecord(buttonElement) {
            showConfirmModal(buttonElement);
        }
        // DELETE LOGIC END //
    </script>
</body>
</html>
